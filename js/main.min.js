!function(e){"use strict";e(function(){function t(e,t){var i=e.offset().left,l=e.offset().top,o=e.outerHeight(!0),n=e.outerWidth(!0),s=l+o,a=i+n,r=t.offset().left,d=t.offset().top,c=t.outerHeight(!0),h=t.outerWidth(!0),p=d+c,u=r+h;return d>s||l>p||r>a||i>u?!1:!0}var i=i||{};i.Data=Backbone.Model.extend(),e.get(ajaxurl,{action:"get_cb_button_tpl"}).done(function(e){i.blocksBtn_tpl=e,i.blockMenu=new i.BlocksContainerView({collection:i.blocksCol})}),i.Uploader=Backbone.Model.extend({initialize:function(){this.params={browse_button:this.get("browse_button"),container:this.get("container"),drop_element:this.get("drop_element"),multi_selectioni:this.get("multi_selectioni")},this.$settings=_.extend({},this.get("defaults"),this.params),this.response={},this.instance=new plupload.Uploader(this.$settings),this.init()},init:function(){var e=this,t=e.instance;setTimeout(function(){t.init(),t.bind("FilesAdded",_.bind(e.filesAdded,this)),t.bind("QueueChanged",_.bind(e.queueChanged,this)),t.trigger("DisableBrowse",!0)},10)},logIt:function(){console.log(this.instance)},filesAdded:function(e){e.start()},queueChanged:function(e){e.start(),e.refresh()}}),i.BlockModel=Backbone.Model.extend(),i.BlocksContainer=Backbone.Collection.extend({url:ajaxurl,model:i.BlockModel,group:function(e){return _(this.filter(function(t){return t.get("group")==e}))},search:function(e){if(""==e)return this;var t=new RegExp(e,"gi");return _(this.filter(function(e){return t.test(e.get("name"))}))}}),i.blocksCol=new i.BlocksContainer,i.BlockButton=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"destroy",this.unrender),this.template=_.template(i.blocksBtn_tpl),this.render()},render:function(){return this.$el.html(this.template({name:this.model.get("name"),slug:this.model.get("slug"),icon:this.model.get("icon"),view:this.model.get("view")})),this}}),i.BlocksContainerView=Backbone.View.extend({el:"#blocksSelect",events:{"keyup #blocks-search":"search","click .customBlock":"addBlock"},initialize:function(){_.bindAll(this,"render"),this.listenTo(this.collection,"reset",this.render),this.defaults=e("#defaults-container"),this.others=e("#others-container"),this.results=e("#results-container");var t={action:"get_content_blocks"},i=this;this.collection.fetch({data:e.param(t),success:function(){i.defaultBlocks=i.collection.group("default"),i.otherBlocks=i.collection.group("other"),i.render()},error:function(e,t){console.log(" Service request failure: "+e),console.log(t.responseText)}})},render:function(){var e=this;e.defaults.html("").append("<h3>Default Blocks</h3>"),e.others.html("").append("<h3>Other Blocks</h3>"),e.defaultBlocks.each(function(t){var l=new i.BlockButton({model:t});e.defaults.append(l.render().el)}),e.otherBlocks.each(function(t){var l=new i.BlockButton({model:t});e.others.append(l.render().el)})},renderList:function(e){this.defaults.html(""),this.others.html(""),this.results.html("");var t=this;e.each(function(e){var l=new i.BlockButton({model:e,collection:t.collection});t.results.append(l.render().el)})},search:function(t){var i=e(t.target).val();i?this.renderList(this.collection.search(i)):(this.results.html(""),this.render())},addBlock:function(t){var l=this.collection.findWhere({slug:e(t.currentTarget).attr("data-type")}),o=l.get("slug"),n=l.get("view");i.view.addBlock(o,n)}}),i.Block=Backbone.Model.extend({defaults:{wp_id:0,remove:!0,move:!0}}),i.Blocks=Backbone.Collection.extend({model:i.Block}),i.blocks=new i.Blocks,i.BlockView=Backbone.View.extend({tagName:"div",className:"content-block",tpl:"#wp-text",isEditable:!1,events:{"click .remove":"destroy","click .move-up":"moveUp","click .move-down":"moveDown"},init:function(){},beforeRender:function(){},afterRender:function(){},initialize:function(){this.beforeRender(),this.trigger("beforeRender"),this.listenTo(this.model,"destroy",this.unrender),this.template=_.template(e(this.tpl).html()),this.events&&(this.events=_.defaults(this.events,i.BlockView.prototype.events)),this.delegateEvents(this.events),this.init(),this.render(),this.afterRender(),this.trigger("afterRender")},render:function(){return this.$el.html(this.template({wp_id:this.model.get("wp_id"),block_type:this.model.get("type"),block_content:this.model.get("body"),remove:this.model.get("remove"),move:this.model.get("move"),editable:this.isEditable})),this},unrender:function(){this.$el.remove()},destroy:function(){this.model.destroy()},moveUp:function(t){var i=e(t.currentTarget).parents(".content-block"),l=i.prev(".content-block");l.insertAfter(i)},moveDown:function(t){var i=e(t.currentTarget).parents(".content-block"),l=i.next(".content-block");l.insertBefore(i)}}),i.textView=i.BlockView.extend({tpl:"#wp-text",isEditable:!0}),i.quoteView=i.BlockView.extend({tpl:"#wp-quote",events:{"keyup textarea":"resizeTextarea"},afterRender:function(){},resizeTextarea:function(){this.$textarea||(this.$textarea=e("#quote_"+this.model.get("wp_id"))),this.$textarea.css({height:"auto"}),this.$textarea.css({height:this.$textarea.prop("scrollHeight")+"px"})}}),i.codeView=i.BlockView.extend({tpl:"#wp-code",isEditable:!0,init:function(){console.log(this.model)}}),i.audioView=i.BlockView.extend({tpl:"#wp-audio",events:{"click .oembed-fetch":"fetchAudio"},init:function(){},fetchAudio:function(t){t.preventDefault();var i=this,l=this.$el.find(".oembed-url"),o=l.val(),n={action:"fetch_cb_audio",url:o};this.model.set({url:o}),e.get(ajaxurl,n).done(function(e){i.setAudio(e)})},setAudio:function(e){this.$el.find(".wp-block").html(e)}}),i.videoView=i.BlockView.extend({tpl:"#wp-video",events:{"click .oembed-fetch":"fetchVideo"},init:function(){console.log(this.model)},fetchVideo:function(t){t.preventDefault();var i=this,l=this.$el.find(".oembed-url"),o=l.val(),n={action:"fetch_cb_video",url:o};this.model.set({url:o}),e.get(ajaxurl,n).done(function(e){i.setVideo(e)})},setVideo:function(e){this.$el.find(".wp-block").html(e)}}),i.embedView=i.BlockView.extend({tpl:"#wp-embed"}),i.tweetView=i.BlockView.extend({tpl:"#wp-tweet"}),i.imgView=i.BlockView.extend({tpl:"#wp-image",events:{"click .open-modal":"mediaModal","click .remove-img":"removeImg","click .opt-size":"imgSize","click .opt-align":"imgAlign","dragover .drag-drop":"dragOver","dragleave .drag-drop":"dragLeave","drop .drag-drop":"dropUpload"},init:function(){this.imgSizes={},this.blockType=this.model.get("type")},afterRender:function(){var e=this.model.get("wp_id");this.upl=new i.Uploader({browse_button:"wp-browse-button-"+e,container:"wp-img-ui-"+e,drop_element:"wp-drag-drop-"+e,multi_selection:!1,defaults:ceux_plupload}),this.upl.instance.bind("FilesAdded",_.bind(this.filesAdded,this)),this.upl.instance.bind("FileUploaded",_.bind(this.fileUploaded,this)),this.upl.instance.bind("UploadProgress",_.bind(this.uploaderProgress,this))},mediaModal:function(e){e.preventDefault();var t=this;"undefined"!=typeof i&&i.close();var i=wp.media.frames.customHeader=wp.media({title:"Select An Image",library:{type:"image"},button:{text:"insert image"},multiple:!1});"wp-image"==this.blockType&&i.on("select",function(){var e=i.state().get("selection").first().toJSON();t.setImg(e)}),i.open()},filesAdded:function(){this.$bar=e('<div class="upload-bg"><div class="upload-bar"><div class="upload-percent"></div><div><p class="upload-label"></p></div>'),this.$el.find(e("."+this.blockType)).append(this.$bar)},uploaderProgress:function(e,t){this.$bar.find(".upload-percent").css("width",e.total.percent+"%"),this.$bar.find(".upload-label").html("Uploading "+t.name)},fileUploaded:function(t,i,l){this.Img=e.parseJSON(l.response),this.setImg(this.Img)},setImg:function(t){var i=this,l="wp-image-"+t.id,o=this.$el.find(e("."+this.blockType)),n=_.template(e("#image-placeholder").html());o.html(n({id:l,url:i.getImgURL(t,"full"),caption:t.caption}))},getImgURL:function(e,t){var i=this;for(var l in e.sizes)e.sizes.hasOwnProperty(l)&&(i.imgSizes[l]=e.sizes[l].url);return i.imgSizes[t]},imgSize:function(t){var i=e(t.currentTarget),l=this.$el.find(".img-file");i.hasClass("selected")||(this.$el.find(".opt-size").removeClass("selected"),i.addClass("selected"),i.hasClass("size-thumbnail")?l.attr("src",this.imgSizes.thumbnail):i.hasClass("size-medium")?l.attr("src",this.imgSizes.medium):i.hasClass("size-full")&&l.attr("src",this.imgSizes.full))},imgAlign:function(t){var i=e(t.currentTarget),l=this.$el.find(".img-file");i.hasClass("selected")||(this.$el.find(".opt-align").removeClass("selected"),i.addClass("selected"),i.hasClass("align-left")?l.attr("class","img-file alignleft"):i.hasClass("align-center")?l.attr("class","img-file aligncenter"):i.hasClass("align-right")?l.attr("class","img-file alignright"):l.attr("class","img-file alignone"))},removeImg:function(e){e.preventDefault(),this.render(),this.afterRender()},dragOver:function(e){e.stopPropagation(),e.preventDefault(),this.$el.find(".drag-drop-area").addClass("drag-over")},dragLeave:function(){this.$el.find(".drag-drop-area").removeClass("drag-over")},dropUpload:function(){this.$el.find(".drag-drop-area").removeClass("drag-over")}}),i.GalleryModel=Backbone.Model.extend(),i.GalleryCollection=Backbone.Collection.extend(),i.galleryImgTemplate=Backbone.View.extend({tagName:"li",className:"wp-gallery-img",events:{"click .img-remove":"removeImg"},initialize:function(){this.listenTo(this.model,"destroy",this.unrender),this.template=_.template(e("#gallery-img-tpl").html())},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},unrender:function(){this.$el.remove()},removeImg:function(){this.model.destroy()}}),i.galleryView=i.BlockView.extend({tpl:"#wp-gallery",events:{"click .open-modal":"mediaModal","click .add-more":"mediaModal","change .cols-num":"setColumns","click .link-type":"setLinkType","dragover .drag-drop":"dragOver","dragleave .drag-drop":"dragLeave","drop .drag-drop":"dropUpload"},init:function(){this.collection=new i.GalleryCollection,this.blockType=this.model.get("type"),this.galleryTpl=_.template(e("#gallery-placeholder").html()),this.model.set({columns:6,link_to:"page"}),this.listenTo(this.collection,"remove reset",this.isEmptyCol),this.listenTo(this.model,"change:columns",this.renderColumns)},afterRender:function(){var e=this.model.get("wp_id");this.upl=new i.Uploader({browse_button:"wp-browse-button-"+e,container:"wp-gallery-ui-"+e,drop_element:"wp-drag-drop-"+e,multi_selection:!0,defaults:ceux_plupload}),this.upl.instance.bind("StateChanged",_.bind(this.stateChanged,this)),this.upl.instance.bind("FileUploaded",_.bind(this.fileUploaded,this)),this.upl.instance.bind("UploadProgress",_.bind(this.uploaderProgress,this))},isEmptyCol:function(){0==this.collection.length&&this.render()},mediaModal:function(e){e.preventDefault();var t=this;"undefined"!=typeof i&&i.close();var i=wp.media.frames.customHeader=wp.media({title:"Select Images",library:{type:"image"},button:{text:"Insert into Gallery"},id:"gallery-frame",multiple:!0});"wp-gallery"==this.blockType&&i.on("select",function(){var e=i.state().get("selection").toJSON();0==t.$el.find(".wp-gallery-list").length&&t.putPlaceholder(),t.setImg(e)}),i.open()},stateChanged:function(t){t.state==plupload.STARTED?(this.putPlaceholder(),this.$bar=e('<div class="upload-bg"><div class="upload-bar"><div class="upload-percent"></div><div><p class="upload-label"></p></div>'),this.$el.find(e("."+this.blockType)).append(this.$bar),this.imgArray=[]):t.state==plupload.STOPPED&&(this.$bar.remove(),this.setImg(this.imgArray))},uploaderProgress:function(e,t){this.$bar.find(".upload-percent").css("width",e.total.percent+"%"),this.$bar.find(".upload-label").html("Uploading "+t.name)},fileUploaded:function(t,i,l){this.Img=e.parseJSON(l.response),this.imgArray.push(this.Img)},putPlaceholder:function(){var t=this.$el.find(e("."+this.blockType));t.html(this.galleryTpl({wp_id:this.model.get("wp_id"),columns:this.model.get("columns"),link_to:this.model.get("link_to")})),e("#wp-gallery-sort-"+this.model.get("wp_id")).sortable({containment:"parent",forceHelperSize:!0,forcePlaceholderSize:!0,helper:"clone",opacity:.8,tolerance:"pointer",placeholder:"gallery-img-placeholder"})},setImg:function(e){var t=this;_.each(e,function(e){var l="wp-gallery-img-"+e.id,o=t.collection.findWhere({imgID:l});if("undefined"==typeof o){var n=new i.GalleryModel({imgID:l,link:e.link,thumb:e.sizes.thumbnail});t.collection.add(n);var s=new i.galleryImgTemplate({model:n});t.$el.find(".wp-gallery-list").append(s.render().el)}})},setColumns:function(t){var i=e(t.currentTarget).val();this.model.set({columns:i})},renderColumns:function(){e("#wp-gallery-sort-"+this.model.get("wp_id")).attr("class","wp-gallery-list columns-"+this.model.get("columns"))},setLinkType:function(t){t.preventDefault();var i=e(t.currentTarget),l=this.$el.find(".link-type"),o=i.attr("data-type");this.model.set({link_to:o}),l.removeClass("selected"),i.addClass("selected")},dragOver:function(e){e.stopPropagation(),e.preventDefault(),this.$el.find(".drag-drop-area").addClass("drag-over")},dragLeave:function(){this.$el.find(".drag-drop-area").removeClass("drag-over")},dropUpload:function(){this.$el.find(".drag-drop-area").removeClass("drag-over")}}),i.View=Backbone.View.extend({el:"#content-blocks",events:{"click #add-block":"blockMenu","change #post-title":"updateTitle","click #publish":"savePost"},initialize:function(){this.container=e("#content"),this.addBtn=e("#blocksSelect"),this.$postPlaceholder=e("#post-placeholder"),this.$postPlaceholderCopy=this.$postPlaceholder.clone(),this.listenTo(this.collection,"reset sync add remove",this.removePlaceholder),this.counter=0,this.render(),this.$el.sortable({handle:".move",connectWith:".content-blocks",placeholder:"blocks-placeholder",start:function(t,i){i.placeholder.height(i.item.outerHeight()),e(".mce-tinymce").hide()}})},render:function(){},removePlaceholder:function(){this.collection.length>0?this.$postPlaceholder.remove():(this.$el.append(this.$postPlaceholderCopy),this.$postPlaceholder=e("#post-placeholder"))},blockMenu:function(e){e.preventDefault(),this.addBtn.toggleClass("active")},addBlock:function(t,l){var o="wp-"+t;this.counter++;var n=new i.Block({wp_id:"block_"+this.counter,type:o}),s=i[l];this.collection.add(n),this.addBtn.removeClass("active");var a=new s({model:n});this.$el.append(a.render().el),a.isEditable&&this.setEditable(e("#"+n.get("wp_id")))},setEditable:function(e){var t=e.find(".editable").attr("id");tinymce.execCommand("mceAddEditor",!1,t)},savePost:function(){console.log(i.blocks.toJSON()),alert("Here we need to get all the data from post.Blocks collection, serialize it and save on the database. The post.Data model will hold the content when the post is loaded, then it should pass it to the post.Blocks collection to rebuild the content blocks.")}}),i.view=new i.View({collection:i.blocks}),tinymce.init({selector:".editable",add_unload_trigger:!1,schema:"html5",inline:!0,fixed_toolbar_container:"#wp-editor-toolbar",menubar:!1,toolbar:"undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",statusbar:!1}),e("#add-block").on("click",function(t){t.preventDefault(),e("#blocksSelect").toggleClass("active")}),e(window).scroll(function(){e("#wp-editor-toolbar").css(t(e("#postdivrich"),e("#wpadminbar"))?{position:"fixed",top:32,zIndex:9999,width:e("#postdivrich").width()}:{position:"static"})})})}(jQuery);